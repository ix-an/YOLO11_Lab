<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>ğŸ›¸ å›¾ç‰‡æ£€æµ‹</title>

    <!-- ================= Element-UI æ ·å¼ ================= -->
    <link rel="stylesheet" href="../static/element-ui/lib/theme-chalk/index.css">
    <!-- ================= Vue ================= -->
    <script src="../static/vue.js"></script>
    <!-- ================= Element-UI ================= -->
    <script src="../static/element-ui/lib/index.js"></script>
    <!-- ================= Axios ================= -->
    <script src="../static/axios/dist/axios.js"></script>

    <!-- ================= é¡µé¢æ ·å¼ï¼ˆä»…æ ·å¼ï¼Œä¸å½±å“é€»è¾‘ï¼‰ ================= -->
    <style>
        body {
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #FFFDF8, #FFECEC);
            font-family: "Helvetica Neue", "PingFang SC", sans-serif;
        }

        /* é¡µé¢æ•´ä½“å®¹å™¨ */
        .detect-container {
            padding: 40px;
        }

        /* ä¸»å¡ç‰‡ */
        .detect-card {
            background: #ffffff;
            border-radius: 24px;
            padding: 36px;
            box-shadow: 0 18px 40px rgba(255, 170, 170, 0.25);
        }

        /* é¡µé¢æ ‡é¢˜ */
        .page-title {
            font-size: 22px;
            font-weight: 600;
            color: #444;
            margin-bottom: 8px;
        }

        .page-subtitle {
            font-size: 14px;
            color: #888;
            margin-bottom: 28px;
        }

        /* ä¸Šä¼ æŒ‰é’®åŒºåŸŸ */
        .upload-area {
            margin-bottom: 30px;
        }

        /* å›¾ç‰‡å±•ç¤ºåŒºåŸŸ */
        .image-preview {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 24px;
            margin-top: 20px;
        }

        /* å•å¼ å›¾ç‰‡å¡ç‰‡ */
        .img-card {
            background: #fafafa;
            border-radius: 20px;
            padding: 16px;
            box-shadow: inset 0 0 0 1px #f2f2f2;
            text-align: center;
        }

        .img-card-title {
            font-size: 14px;
            color: #666;
            margin-bottom: 12px;
        }

        .img-card img {
            max-width: 100%;
            border-radius: 16px;
        }

        /* å“åº”å¼ï¼šçª„å±æ”¹ä¸ºä¸€åˆ— */
        @media (max-width: 900px) {
            .image-preview {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>
<div id="app" class="detect-container">

    <!-- ================= ä¸»ä½“å¡ç‰‡ ================= -->
    <div class="detect-card">

        <!-- æ ‡é¢˜è¯´æ˜ -->
        <div class="page-title">ğŸ›¸ å›¾ç‰‡æ£€æµ‹</div>
        <div class="page-subtitle">
            ä¸Šä¼ ä¸€å¼ å›¾ç‰‡ï¼Œä½¿ç”¨ YOLO æ¨¡å‹è¿›è¡Œç›®æ ‡æ£€æµ‹~
        </div>

        <!-- ================= ä¸Šä¼ åŒºåŸŸï¼ˆé€»è¾‘å®Œå…¨ä¸å˜ï¼‰ ================= -->
        <div class="upload-area">
            <!--
                el-uploadï¼šElement-UI ä¸Šä¼ ç»„ä»¶
                âš  ä»¥ä¸‹å‚æ•°å’Œé€»è¾‘å®Œå…¨ä¿æŒä½ çš„åŸæ ·
            -->
            <el-upload
                    class="upload-demo"
                    ref="upload"
                    action="https://jsonplaceholder.typicode.com/posts/"
                    :show-file-list="false"
                    :on-change="handleChange"
                    :auto-upload="false">

                <el-button slot="trigger" size="small" type="primary">
                    é€‰æ‹©å›¾ç‰‡
                </el-button>

                <el-button
                        style="margin-left: 12px;"
                        size="small"
                        type="success"
                        @click="submitUpload">
                    æ‰§è¡Œæ£€æµ‹ âœ¨
                </el-button>
            </el-upload>
        </div>

        <!-- ================= å›¾ç‰‡å±•ç¤ºåŒºåŸŸ ================= -->
        <div class="image-preview">

            <!-- åŸå§‹å›¾ç‰‡ -->
            <div class="img-card" v-show="chooseImg">
                <div class="img-card-title">ğŸ“· åŸå§‹å›¾ç‰‡</div>
                <img :src="chooseImg" alt="">
            </div>

            <!-- æ£€æµ‹ç»“æœå›¾ç‰‡ -->
            <div class="img-card" v-show="resultImg">
                <div class="img-card-title">ğŸ¯ æ£€æµ‹ç»“æœ</div>
                <img :src="resultImg" alt="">
            </div>

        </div>
    </div>
</div>

<!-- ================= Vue é€»è¾‘ ================= -->
<script>
    new Vue({
        el: '#app',
        data() {
            return {
                file: null,          // å½“å‰é€‰æ‹©çš„å›¾ç‰‡å¯¹è±¡
                chooseImg: '',       // åŸå§‹å›¾ç‰‡ base64
                fileList: [],        // æ–‡ä»¶åˆ—è¡¨
                resultImg: '',       // æ£€æµ‹ç»“æœå›¾ç‰‡è·¯å¾„
            }
        },
        methods:{
            // æ–‡ä»¶é€‰æ‹©å˜åŒ–
            handleChange(file, fileList) {
                this.file = file;
                this.resultImg = '';
                this.showImg();
            },
            // æ˜¾ç¤ºåŸå§‹å›¾ç‰‡
            showImg() {
                let _this = this;
                let file = _this.file;
                let reader = new FileReader();
                reader.readAsDataURL(file.raw);
                reader.onload = function (e) {
                    _this.chooseImg = e.target.result;
                }
            },
            // æäº¤æ£€æµ‹
            submitUpload() {
                let fileData = this.file.raw;
                let username = sessionStorage.getItem('username');

                let formData = new FormData();
                formData.append('file', fileData);
                formData.append('username', username);

                axios({
                    url: '/detectImg/',
                    method: 'post',
                    data: formData,
                }).then(res => {
                    let status = res.data.status;
                    let msg = res.data.msg;
                    let classesNumber = res.data.data.classesNumber;
                    let avgConf = res.data.data.avgConf;
                    let resultUrl = 'http://localhost:8000/' + res.data.data.resultUrl;

                    if (status === 200) {
                        this.$alert(
                            "æ£€æµ‹ç»“æœä¸ºï¼š" + JSON.stringify(classesNumber) +
                            "<br/>å¹³å‡ç½®ä¿¡åº¦ï¼š" + avgConf,
                            {
                                confirmButtonText: "ç¡®å®š",
                                type: "success",
                                dangerouslyUseHTMLString: true
                            }
                        )
                        this.resultImg = resultUrl;
                    } else {
                        this.$message.error(msg);
                    }
                })
            },
        }
    })
</script>
</body>
</html>
